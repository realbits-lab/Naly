# Implement Vercel Cron Jobs for Automated Agent Scheduling

## Summary
Implement proper Vercel cron jobs infrastructure to automate the scheduling and execution of AI agents (Reporter, Marketer, Editor, Designer) in both backend and admin frontend. This will replace the current manual triggering system with a production-ready automated scheduling solution.

## Background
The project currently has:
- A scheduler implementation (`src/lib/scheduler.ts`) with `checkAndTriggerJobs()` function
- An existing cron endpoint (`src/app/api/cron/tick/route.ts`)
- Admin dashboard with manual "Run Now" buttons
- Agent configurations stored in database with cron schedules

However, there is no Vercel-specific cron configuration to automatically trigger these jobs in production.

## Motivation
- **Automation**: Enable hands-free content generation on a predictable schedule
- **Production-Ready**: Leverage Vercel's native cron infrastructure instead of external services
- **Cost-Effective**: Use Vercel's built-in cron jobs (2 free jobs on Hobby plan)
- **Reliability**: Ensure scheduled tasks run even when no users are active
- **Monitoring**: Provide visibility into cron job execution via admin dashboard

## Implementation Requirements

### 1. Backend: Vercel Cron Configuration

#### 1.1 Create `vercel.json` Configuration
Create a `vercel.json` file at the project root with cron job definitions:

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "crons": [
    {
      "path": "/api/cron/tick",
      "schedule": "0 * * * *"
    }
  ]
}
```

**Considerations:**
- The schedule `0 * * * *` runs every hour (adjust based on needs)
- Vercel cron jobs use UTC timezone
- Free tier allows 2 cron jobs, each triggered max once per day
- Path must match the existing endpoint `/api/cron/tick`

#### 1.2 Secure Cron Endpoint with `CRON_SECRET`

Update `/src/app/api/cron/tick/route.ts` to validate requests:

```typescript
import { checkAndTriggerJobs } from '@/lib/scheduler';
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  // Verify the request is from Vercel Cron
  const authHeader = request.headers.get('authorization');

  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json(
      { success: false, error: 'Unauthorized' },
      { status: 401 }
    );
  }

  try {
    await checkAndTriggerJobs();
    return NextResponse.json({ success: true, timestamp: new Date().toISOString() });
  } catch (error: any) {
    console.error('Cron job failed:', error);
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}

// Ensure the route is dynamic and not cached
export const dynamic = 'force-dynamic';
```

**Security Steps:**
1. Generate a secure random string (16+ characters) using 1Password or similar
2. Add `CRON_SECRET` environment variable in Vercel dashboard
3. Add to `.env.example` file with placeholder value
4. Update `.env` locally for testing

#### 1.3 Add Monitoring and Logging

Enhance the cron endpoint to log execution details:

```typescript
export async function GET(request: Request) {
  const startTime = Date.now();

  // ... auth check ...

  try {
    console.log('[CRON] Starting scheduled job check at', new Date().toISOString());
    const result = await checkAndTriggerJobs();
    const duration = Date.now() - startTime;

    console.log('[CRON] Completed in', duration, 'ms');

    return NextResponse.json({
      success: true,
      timestamp: new Date().toISOString(),
      duration,
      jobsTriggered: result?.jobsTriggered || 0
    });
  } catch (error: any) {
    console.error('[CRON] Failed:', error);
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}
```

### 2. Admin Frontend: Cron Job Monitoring Dashboard

#### 2.1 Create Cron Status Component

Add a new section to `/src/app/admin/dashboard/page.tsx` to display cron job status:

```typescript
// Add this component to show Vercel cron status
const CronStatusCard = () => {
  return (
    <div className="rounded-xl bg-white p-6 shadow-sm border border-gray-100">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <Clock className="text-indigo-500" /> Automated Scheduling
        </h3>
        <span className="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
          ACTIVE
        </span>
      </div>

      <div className="mt-4 space-y-2 text-sm text-gray-600">
        <p>Vercel Cron: <span className="font-medium text-gray-900">Every hour</span></p>
        <p>Next Run: <span className="font-medium text-gray-900">{nextRunTime}</span></p>
        <p>Last Execution: <span className="font-medium text-gray-900">{lastRunTime}</span></p>
      </div>

      <div className="mt-6">
        <a
          href="https://vercel.com/docs/cron-jobs"
          target="_blank"
          rel="noopener noreferrer"
          className="text-sm text-blue-600 hover:text-blue-700 font-medium"
        >
          View Vercel Cron Docs â†’
        </a>
      </div>
    </div>
  );
};
```

#### 2.2 Add Cron Execution History

Create a new table to show recent cron executions:

```typescript
// Add to database schema (if not exists)
export const cronExecutions = pgTable('cron_executions', {
  id: serial('id').primaryKey(),
  startTime: timestamp('start_time').notNull(),
  endTime: timestamp('end_time'),
  status: varchar('status', { length: 20 }).notNull(), // SUCCESS, FAILED
  jobsTriggered: integer('jobs_triggered').default(0),
  errorMessage: text('error_message'),
  duration: integer('duration'), // in milliseconds
});
```

Update the cron endpoint to log executions to the database.

#### 2.3 Test Cron Endpoint UI

Add a "Test Cron" button for admins to manually trigger the cron endpoint:

```typescript
<form action={async () => {
  'use server';
  const response = await fetch(`${process.env.NEXTAUTH_URL}/api/cron/tick`, {
    headers: {
      'Authorization': `Bearer ${process.env.CRON_SECRET}`
    }
  });
  const data = await response.json();
  // Handle response
}}>
  <button className="flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-500 transition-colors">
    <Play size={16} /> Test Cron Endpoint
  </button>
</form>
```

### 3. Documentation Updates

#### 3.1 Update README.md

Add a new section about cron jobs:

```markdown
## Automated Scheduling

Naly uses Vercel Cron Jobs to automatically trigger AI agents on a schedule.

### Configuration

1. Cron jobs are configured in `vercel.json`
2. Set `CRON_SECRET` environment variable in Vercel dashboard
3. Cron jobs run in UTC timezone
4. View execution logs in Vercel dashboard under "Cron Jobs" tab

### Local Testing

To test the cron endpoint locally:

```bash
curl http://localhost:3000/api/cron/tick \
  -H "Authorization: Bearer your-cron-secret"
```
```

#### 3.2 Update `.env.example`

```env
# Vercel Cron Jobs
CRON_SECRET=generate-a-random-secret-16-chars-min
```

### 4. Testing Strategy

#### 4.1 Local Testing
1. Set `CRON_SECRET` in `.env`
2. Use curl or Postman to test the endpoint with proper auth header
3. Verify `checkAndTriggerJobs()` executes correctly
4. Check database for new agent runs

#### 4.2 Preview Deployment Testing
Note: Vercel cron jobs do NOT run on preview deployments. Testing must be done via:
- Manual endpoint invocation
- Vercel dashboard cron job triggers (after production deploy)

#### 4.3 Production Testing
1. Deploy to production with `vercel --prod`
2. Monitor first cron execution in Vercel dashboard
3. Check admin dashboard for new agent runs
4. Review Vercel logs for any errors

### 5. Deployment Checklist

- [ ] Create `vercel.json` with cron configuration
- [ ] Update cron endpoint with security checks
- [ ] Add `CRON_SECRET` environment variable in Vercel
- [ ] Add `dynamic = 'force-dynamic'` to route
- [ ] Deploy to production
- [ ] Verify first cron execution
- [ ] Monitor logs in Vercel dashboard
- [ ] Update admin dashboard with cron status
- [ ] Update documentation
- [ ] Test manual "Run Now" still works alongside automated cron

## Technical Considerations

### Limitations
- **Free Tier**: Vercel Hobby plan allows 2 cron jobs, each max once/day
- **No Retries**: Vercel does not retry failed cron jobs automatically
- **UTC Only**: All schedules are in UTC timezone
- **Production Only**: Cron jobs only run on production deployments
- **Timeout**: Cron jobs inherit serverless function timeout limits (10s hobby, 60s pro)

### Best Practices
1. **Idempotency**: Ensure `checkAndTriggerJobs()` can be safely run multiple times
2. **Error Handling**: Log all errors for debugging
3. **Monitoring**: Track execution times and success rates
4. **Security**: Always validate `CRON_SECRET` header
5. **Logging**: Use structured logging for easy debugging in Vercel

### Error Recovery
Since Vercel doesn't retry failed cron jobs:
1. Implement robust error handling in `checkAndTriggerJobs()`
2. Log failures to database for admin visibility
3. Consider adding a "retry failed jobs" button in admin UI
4. Set up alerts for consecutive failures (future enhancement)

## Success Criteria
- [ ] Vercel cron jobs configured and running in production
- [ ] Cron endpoint secured with `CRON_SECRET`
- [ ] Admin dashboard shows cron job status
- [ ] Documentation updated with cron setup instructions
- [ ] First scheduled agent run completes successfully
- [ ] Logs show successful cron execution
- [ ] Manual "Run Now" functionality still works

## Resources
- [Vercel Cron Jobs Documentation](https://vercel.com/docs/cron-jobs)
- [Vercel Cron Jobs Quickstart](https://vercel.com/docs/cron-jobs/quickstart)
- [Managing Vercel Cron Jobs](https://vercel.com/docs/cron-jobs/manage-cron-jobs)
- [Troubleshooting Vercel Cron Jobs](https://vercel.com/guides/troubleshooting-vercel-cron-jobs)
- [Cron Expression Reference](https://crontab.guru/)

## Related Issues
- Existing scheduler implementation in `src/lib/scheduler.ts`
- Admin dashboard at `src/app/admin/dashboard/page.tsx`
- Agent configuration management

## Priority
**High** - This is essential for production readiness and automated content generation.

## Estimated Effort
- Backend implementation: 2-3 hours
- Frontend monitoring UI: 2-3 hours
- Testing and documentation: 1-2 hours
- **Total**: 5-8 hours
